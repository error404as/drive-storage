var DriveStorage=function(){var a,b,c,d={},e="drivesave-",f="."+e,g=f+"overlay",h=e+"overlay",i=f+"popup",j=e+"popup",k="#"+e+"fname",l={gapiLoading:!1,data:null,helper:null,doLater:null,options:{},init:function(){l.ui.add(),l.auth.loadGapi()},reset:function(){l.options={},l.data=null,l.doLater=null,l.ui.hidePopup(),l.ui.lockScreen(!1)},isReady:function(){return l.ui.add(),"undefined"!=typeof gapi||l.gapiLoading?gapi.client.drive?!0:(l.auth.checkAuth(),!1):(l.auth.loadGapi(),!1)},getData:function(){return l.isReady()?(l.helper="load",void l.drive.getDataFromDrive()):void(l.doLater=function(){l.getData()})},saveData:function(a){var b=l.ui,c=l.drive;return a&&(l.data=a),l.isReady()?(l.helper="save",b.hidePopup(),b.lockScreen(!0,"Saving app data"),c.getFileMetadata(),c.metadata?void c.checkFileExists(c.metadata.title,c.saveDataHandle):(b.showPopup("new"),b.lockScreen(!1),!1)):void(l.doLater=function(){l.saveData()})}};return l.auth={loadGapi:function(a){a=a||"DriveStorage_clientLoaded",l.gapiLoading=!0,l.ui.lockScreen(!0,"Loading Google API");var b=document.createElement("script");b.src="https://apis.google.com/js/client.js?onload="+a,document.getElementsByTagName("head")[0].appendChild(b)},handleClientLoad:function(){window.setTimeout(l.auth.checkAuth,1)},checkAuth:function(){l.ui.lockScreen(!0,"Authorization with Google"),gapi.auth.authorize({client_id:CLIENT_ID,scope:SCOPES,immediate:!0},l.auth.handleAuthResult)},checkAuth2:function(){gapi.auth.getToken()||gapi.auth.authorize({client_id:CLIENT_ID,scope:SCOPES,immediate:!1},l.auth.handleAuthResult)},handleAuthResult:function(a){var b=l.ui;l.options;b.lockScreen(!1),a&&!a.error?(d.callback.auth(),b.lockScreen(!0,"Loading Google Drive API"),gapi.client.load("drive","v2",function(){gapi.load("picker",function(){b.lockScreen(!1),d.callback.drive(),"function"==typeof l.doLater&&(l.doLater(),l.doLater=null)})})):l.auth.checkAuth2()}},l.ui={add:function(){if(!$(g).length){var a='<div class="'+h+'"><!----></div><div class="'+j+'" id="'+e+'new"><i class="ico-close">close</i><br>Create file on Drive: <input type="text" id="'+e+'fname" value=""> <input type="button" class="'+e+'btn-new" value="Create"><br><br>Or: <input type="button" class="'+e+'btn-picker" value="Select file on Drive to rewrite"></div><div class="'+j+' tcenter" id="'+e+'exists">File with this name already exists. Do you want to use it anyway?<br><span class="msg"></span><br><br><input type="button" class="'+e+'btn-save" value="Sure"> <input type="button" class="'+e+'btn-new-abort" value="Back"></div><div class="'+j+' tcenter" id="'+e+'error"><i class="ico-close">close</i><br><span class="msg"></span><br><br></div>';$("body").append(a),$("body").on("click",i+" .ico-close",l.reset).on("click",f+"btn-new",l.drive.addNewFile).on("click",f+"btn-new-abort",l.drive.addNewExistsBack).on("click",f+"btn-save",function(){l.saveData()}).on("click",f+"btn-picker",l.drive.createPicker)}},lockScreen:function(a,b){a?($("body").addClass(e+"locked"),b&&$("body").attr("lockmsg",b)):$("body").removeClass(e+"locked").removeAttr("lockmsg")},hidePopup:function(){$(g+", "+i).hide()},showPopup:function(a,b){var c=a?$("#"+e+a):null;c&&c.length&&($(g).show(),$(i).hide(),$("#"+e+a).show(),b=b||"","new"===a?$(k).focus():"error"===a&&(b=b||"Sorry, something bad happend.. Please try later."),$("#"+e+a).find(".msg").html(b))}},l.drive={metadata:{},getFileMetadata:function(){l.options.dr_title?this.metadata={title:l.options.dr_title,mimeType:"application/json"}:this.metadata=null},saveDataHandle:function(a){a&&a.id?l.drive.saveToFile(a.id):l.drive.saveToFile()},saveToFile:function(a){var b=(l.ui,l.drive.metadata),c=l.options;const e="-------314159265358979323846264",f="\r\n--"+e+"\r\n",g="\r\n--"+e+"--";var h="string"==typeof l.data?l.data:JSON.stringify(l.data),i=unescape(encodeURIComponent(h)),j=btoa(i),k=f+"Content-Type: application/json\r\n\r\n"+JSON.stringify(b)+f+"Content-Type: application/json\r\nContent-Transfer-Encoding: base64\r\n\r\n"+j+g;if(a)var m=gapi.client.request({path:"/upload/drive/v2/files/"+a,method:"PUT",params:{uploadType:"multipart",alt:"json"},headers:{"Content-Type":'multipart/mixed; boundary="'+e+'"'},body:k});else var m=gapi.client.request({path:"/upload/drive/v2/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+e+'"'},body:k});m.execute(function(b){c.trash&&l.drive.restoreFromTrash(a),l.reset(),d.callback.saved()})},restoreFromTrash:function(a){var b=(l.ui,gapi.client.drive.files.untrash({fileId:a}));b.execute(function(a){})},checkFileExists:function(a,b){var c=gapi.client.drive.files.list({q:"title='"+a+"'"});c.execute(function(a){if(console.log(a),"function"==typeof b){a.items?a.items.length:0;a.items&&a.items.length&&a.items[0].id?b(a.items[0]):b()}})},createPicker:function(){if(!gapi.auth.getToken())return void l.auth.checkAuth2();if("undefined"==typeof google)return void l.auth.checkAuth();var a=gapi.auth.getToken().access_token,b=(new google.picker.PickerBuilder).addView((new google.picker.DocsView).setIncludeFolders(!0).setMode(google.picker.DocsViewMode.LIST)).enableFeature(google.picker.Feature.MINE_ONLY).setOAuthToken(a).setDeveloperKey(DEV_KEY).setCallback(l.drive.pickerCallback).build();b.setVisible(!0)},pickerCallback:function(a){var b=(l.ui,l.options);a.action==google.picker.Action.PICKED&&(b.dr_id=a.docs[0].id,b.dr_title=a.docs[0].name,"load"===l.helper?l.getData():"save"===l.helper&&l.saveData())},downloadFile:function(a){var b=l.ui;if(a.downloadUrl){var c=gapi.auth.getToken().access_token,e=new XMLHttpRequest;e.open("GET",a.downloadUrl),e.setRequestHeader("Authorization","Bearer "+c),e.onload=function(){b.lockScreen(!1);var a=e.responseText;try{l.data=JSON.parse(a)}catch(c){l.data=a}d.callback.loaded(l.data),l.reset()},e.onerror=function(){b.lockScreen(!1),l.reset()},e.send()}else l.reset()},getDataFromDrive:function(){var a=l.ui;a.hidePopup();var b=l.options.dr_id;if(!b)return l.drive.createPicker(),!1;a.lockScreen(!0,"Loading data from Drive");var c=gapi.client.drive.files.get({fileId:b});c.execute(function(a){l.drive.downloadFile(a)})},addNewFile:function(){var a=$.trim($(k).val());a&&l.drive.checkFileExists(a,l.drive.addNewFileHandle)},addNewFileHandle:function(a){var b=l.ui,c=l.options;if(a&&a.id&&a.title){c.dr_id=a.id,c.dr_title=a.title;var d="";a.labels.trashed?(c.trash=!0,d="It is in Trash folder! Will be restored if continue."):c.trash=!1,b.showPopup("exists",d)}else b.hidePopup(),c.dr_title=$.trim($(k).val()),l.saveData();$(k).val("")},addNewExistsBack:function(){l.ui.showPopup("new"),l.options={}}},d.init=function(d,e,f){a=d,b=e,c=f},d.get=function(){l.getData()},d.save=function(a){l.saveData(a)},d.authGapi=function(a){l.auth.loadGapi(a)},d.authHandle=function(){l.auth.handleClientLoad()},d.get=function(){l.getData()},d.ui={lockScreen:function(a,b){l.ui.lockScreen(a,b)},showPopup:function(a,b){l.ui.showPopup(a,b)},hidePopup:function(){l.ui.hidePopup()}},d.callback={auth:function(){},drive:function(){},saved:function(){},loaded:function(a){}},d}(),DriveStorage_clientLoaded=function(){DriveStorage.authHandle()};