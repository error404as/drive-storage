var DriveStorage=function(){return{}}(),Vapp={gapiLoading:!1,data:null,helper:null,doLater:null,options:{},init:function(){Vapp.ui.add(),Vapp.auth.loadGapi("vapp_clientLoad")},reset:function(){Vapp.options={},Vapp.data=null,Vapp.doLater=null,Vapp.ui.hidePopup(),Vapp.ui.lockScreen(!1)},isReady:function(){return Vapp.ui.add(),"undefined"!=typeof gapi||Vapp.gapiLoading?gapi.client.drive?!0:(Vapp.auth.checkAuth(),!1):(Vapp.auth.loadGapi("vapp_clientLoad"),!1)},getData:function(){return Vapp.isReady()?(Vapp.helper="load",void Vapp.drive.getDataFromDrive()):void(Vapp.doLater=function(){Vapp.getData()})},saveData:function(a){var b=Vapp.ui,c=Vapp.drive;return Vapp.data=a||Vapp.data,Vapp.isReady()?(Vapp.helper="save",b.hidePopup(),b.lockScreen(!0,"Saving app data"),c.getFileMetadata(),c.metadata?void c.checkFileExists(c.metadata.title,c.saveDataHandle):(b.showPopup("new"),b.lockScreen(!1),!1)):void(Vapp.doLater=function(){Vapp.saveData()})}};Vapp.auth={loadGapi:function(a){a=a||"vapp_clientLoad",Vapp.gapiLoading=!0,Vapp.ui.lockScreen(!0,"Loading Google API");var b=document.createElement("script");b.src="https://apis.google.com/js/client.js?onload="+a,document.getElementsByTagName("head")[0].appendChild(b)},handleClientLoad:function(){window.setTimeout(Vapp.auth.checkAuth,1)},checkAuth:function(){Vapp.ui.lockScreen(!0,"Authorization with Google"),gapi.auth.authorize({client_id:CLIENT_ID,scope:SCOPES,immediate:!0},Vapp.auth.handleAuthResult)},checkAuth2:function(){gapi.auth.getToken()||gapi.auth.authorize({client_id:CLIENT_ID,scope:SCOPES,immediate:!1},Vapp.auth.handleAuthResult)},handleAuthResult:function(a){var b=Vapp.ui;Vapp.options;b.lockScreen(!1),a&&!a.error?(Vapp.callback.authOK(),b.lockScreen(!0,"Loading Google Drive API"),gapi.client.load("drive","v2",function(){gapi.load("picker",function(){b.lockScreen(!1),Vapp.callback.driveOK(),"function"==typeof Vapp.doLater&&(Vapp.doLater(),Vapp.doLater=null)})})):Vapp.auth.checkAuth2()}};var vapp_clientLoad=function(){Vapp.auth.handleClientLoad()};Vapp.ui={add:function(){if(!$(".drivesave-overlay").length){var a='<div class="drivesave-overlay"><!----></div><div class="drivesave-popup" id="drivesave-new"><i class="ico-close">close</i><br>Create file on Drive: <input type="text" id="drivesave-fname" value=""> <input type="button" onclick="Vapp.drive.addNewFile()" value="Create"><br><br>Or: <input type="button" onclick="Vapp.drive.createPicker()" value="Select file on Drive to rewrite"></div><div class="drivesave-popup tcenter" id="drivesave-exists">File with this name already exists. Do you want to use it anyway?<br><span class="msg"></span><br><br><input type="button" onclick="Vapp.saveData()" value="Sure"> <input type="button" onclick="Vapp.drive.addNewExistsBack()" value="Back"></div>';$("body").append(a),$(".drivesave-popup .ico-close").on("click",Vapp.reset)}},lockScreen:function(a,b){a?($("body").addClass("drivesave-locked"),b&&$("body").attr("lockmsg",b)):$("body").removeClass("drivesave-locked").removeAttr("lockmsg")},hidePopup:function(){$(".drivesave-overlay, .drivesave-popup").hide()},showPopup:function(a){var b=a?$("#drivesave-"+a):null;b&&b.length&&($(".drivesave-overlay").show(),$(".drivesave-popup").hide(),$("#drivesave-"+a).show(),"new"===a&&$("#drivesave-fname").focus())},existsMsg:function(a){$("#drivesave-exists .msg").html(a)}},Vapp.drive={metadata:{},getFileMetadata:function(){Vapp.options.dr_title?this.metadata={title:Vapp.options.dr_title,mimeType:"application/json"}:this.metadata=null},saveDataHandle:function(a){a&&a.id?Vapp.drive.saveToFile(a.id):Vapp.drive.saveToFile()},saveToFile:function(a){var b=(Vapp.ui,Vapp.drive.metadata),c=Vapp.options;const d="-------314159265358979323846264",e="\r\n--"+d+"\r\n",f="\r\n--"+d+"--";var g="string"==typeof Vapp.data?Vapp.data:JSON.stringify(Vapp.data),h=unescape(encodeURIComponent(g)),i=btoa(h),j=e+"Content-Type: application/json\r\n\r\n"+JSON.stringify(b)+e+"Content-Type: application/json\r\nContent-Transfer-Encoding: base64\r\n\r\n"+i+f;if(a)var k=gapi.client.request({path:"/upload/drive/v2/files/"+a,method:"PUT",params:{uploadType:"multipart",alt:"json"},headers:{"Content-Type":'multipart/mixed; boundary="'+d+'"'},body:j});else var k=gapi.client.request({path:"/upload/drive/v2/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+d+'"'},body:j});k.execute(function(b){c.trash&&Vapp.drive.restoreFromTrash(a),Vapp.reset(),Vapp.callback.dataSaved()})},restoreFromTrash:function(a){var b=(Vapp.ui,gapi.client.drive.files.untrash({fileId:a}));b.execute(function(a){})},checkFileExists:function(a,b){var c=gapi.client.drive.files.list({q:"title='"+a+"'"});c.execute(function(a){if(console.log(a),"function"==typeof b){a.items?a.items.length:0;a.items&&a.items.length&&a.items[0].id?b(a.items[0]):b()}})},createPicker:function(){if(!gapi.auth.getToken())return void Vapp.auth.checkAuth2();if("undefined"==typeof google)return void Vapp.auth.checkAuth();var a=gapi.auth.getToken().access_token,b=(new google.picker.PickerBuilder).addView((new google.picker.DocsView).setIncludeFolders(!0).setMode(google.picker.DocsViewMode.LIST)).enableFeature(google.picker.Feature.MINE_ONLY).setOAuthToken(a).setDeveloperKey(DEV_KEY).setCallback(Vapp.drive.pickerCallback).build();b.setVisible(!0)},pickerCallback:function(a){var b=(Vapp.ui,Vapp.options);a.action==google.picker.Action.PICKED&&(b.dr_id=a.docs[0].id,b.dr_title=a.docs[0].name,"load"===Vapp.helper?Vapp.getData():"save"===Vapp.helper&&Vapp.saveData())},downloadFile:function(a){var b=Vapp.ui;if(a.downloadUrl){var c=gapi.auth.getToken().access_token,d=new XMLHttpRequest;d.open("GET",a.downloadUrl),d.setRequestHeader("Authorization","Bearer "+c),d.onload=function(){b.lockScreen(!1);var a=d.responseText;try{Vapp.data=JSON.parse(a)}catch(c){Vapp.data=a}Vapp.callback.dataLoaded(Vapp.data),Vapp.reset()},d.onerror=function(){b.lockScreen(!1),Vapp.reset()},d.send()}else Vapp.reset()},getDataFromDrive:function(){var a=Vapp.ui;a.hidePopup();var b=Vapp.options.dr_id;if(!b)return Vapp.drive.createPicker(),!1;a.lockScreen(!0,"Loading data from Drive");var c=gapi.client.drive.files.get({fileId:b});c.execute(function(a){Vapp.drive.downloadFile(a)})},addNewFile:function(){var a=$.trim($("#drivesave-fname").val());a&&Vapp.drive.checkFileExists(a,Vapp.drive.addNewFileHandle)},addNewFileHandle:function(a){var b=Vapp.ui,c=Vapp.options;a&&a.id&&a.title?(c.dr_id=a.id,c.dr_title=a.title,b.showPopup("exists"),a.labels.trashed?(c.trash=!0,b.existsMsg("It is in Trash folder! Will be restored if continue.")):(c.trash=!1,b.existsMsg(""))):(b.hidePopup(),c.dr_title=$.trim($("#drivesave-fname").val()),Vapp.saveData()),$("#drivesave-fname").val("")},addNewExistsBack:function(){Vapp.ui.showPopup("new"),Vapp.options={}}},Vapp.callback={authOK:function(){console.log("Callback: authOK")},driveOK:function(){console.log("Callback: driveOK")},dataSaved:function(){console.log("Callback: dataSaved")},dataLoaded:function(a){console.log("Callback: dataLoaded ->"),console.log(a)}};